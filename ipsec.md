# IPSec

- IPパケットをカプセル化して伝送する規定
- IPv4, IPv6 で使用可能

## 通信モード

- **トランスポートモード** : 全区間（終端ノード間）に渡ってカプセル化の対象とする
- **トンネルモード**：一部の区間（通信経路上のルータ）をカプセル化の対象とする

## セキュリティポリシ

**セレクタ**：パケットの種類を識別する情報。IPアドレス、ポート番号、上位層プロトコル

セレクタに応じた動作

- PROTECT: IPsecの処理（カプセル化/カプセル化解除）を行う
- BYPASS：IPsecの処理を行わず、通常の処理をい行う
- DISCARD：パケットを破棄する

**セキュリティポリシ**：セレクタと動作の組

ゲートウェイは、複数のセキュリティポリシを持つことができ、**SPD** (Security Policy Database) に登録される。

## SA

SA (Security Association): IPsecで用いられるコネクション

SAの種類

- ISAKMP SA (IKE SA)：制御用のトンネル。IPsec　SAに先立って生成され、IPsec SAを生成するためのデータ交換を安全に行うために用いられる。
- IPSec SA：実際の通信に使うトンネル。上り用と下り用の二つが同時に生成される。セレクタごとに別々のIPsec SAが生成される。

## IKE

- IPSec鍵交換のためのプロトコル
- 送信元と宛先のポート番号：UDP/500
- イニシエータ：起動側
- レスポンダ：応答側

IKE は、2つのフェーズから構成される。

- フェーズ1では ISAKMP SA / IKE SA を確立する
- フェーズ2 では IPSec SA を確立する

フェーズ1の種類

- メインモード：相手のIPアドレスを元にPSK(Pre-Shared Key)を選ぶ。イニシエータ・レスポンダのIPアドレスが固定
- アグレッシブモード：イニシエータのIPアドレスは固定でなくてもよい。※ IKEv2ではアグレッシブモードが廃止

フェーズ2の種類

- クイックモード：IPsec SA で使われる暗号化、認証および共有鍵のためのデータ交換が行われる。

1. フェーズ1
    1. パラメータの交換：処理2, 3に必要な暗号化アルゴリズム、認証アルゴリズムなどの交換
    2. 秘密鍵の生成：Diffie-Helman交換により、互いに同じ秘密鍵を生成し共有できるよう、乱数を安全に交換する。この鍵は フェーズ2で用いられる。
    3. IPsec通信を行う機器の認証：通常、事前共有鍵方式が用いられる。これは、イニシエータ、レスポンダが事前にPSKを共有する方式である。
2. フェーズ2
    1. IPsec SA で使われる暗号化、認証および共有鍵のためのデータ交換が行われる。

# Ref

- https://www.furukawa.co.jp/network/vpn/about_vpn/ipsec/ipsec_top.html
